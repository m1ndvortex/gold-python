# Fluentd Configuration for Universal Inventory Management System
# Centralized logging with structured output and filtering

<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Nginx Access Logs
<source>
  @type tail
  path /var/log/goldshop/nginx/access.log
  pos_file /var/log/fluentd/nginx_access.log.pos
  tag nginx.access
  format nginx
  time_format %d/%b/%Y:%H:%M:%S %z
</source>

# Nginx Error Logs
<source>
  @type tail
  path /var/log/goldshop/nginx/error.log
  pos_file /var/log/fluentd/nginx_error.log.pos
  tag nginx.error
  format /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+).(?<tid>\d+): (?<message>.*)$/
  time_format %Y/%m/%d %H:%M:%S
</source>

# Backend Application Logs
<source>
  @type tail
  path /var/log/goldshop/backend/*.log
  pos_file /var/log/fluentd/backend.log.pos
  tag backend.app
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
</source>

# Frontend Application Logs
<source>
  @type tail
  path /var/log/goldshop/frontend/*.log
  pos_file /var/log/fluentd/frontend.log.pos
  tag frontend.app
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
</source>

# Filter to add common fields
<filter **>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    service_name goldshop
    environment "#{ENV['ENVIRONMENT'] || 'development'}"
  </record>
</filter>

# Filter for error detection
<filter **>
  @type grep
  <regexp>
    key message
    pattern (ERROR|CRITICAL|FATAL|Exception|Traceback)
  </regexp>
  tag error.${tag}
</filter>

# Output to file for development
<match **>
  @type file
  path /var/log/goldshop/aggregated/goldshop
  append true
  time_slice_format %Y%m%d
  time_slice_wait 10m
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  format json
  include_time_key true
  
  <buffer>
    @type file
    path /var/log/fluentd/buffer/goldshop
    flush_mode interval
    flush_interval 30s
    chunk_limit_size 10MB
    queue_limit_length 512
    retry_max_interval 30
    retry_forever true
  </buffer>
</match>

# Output errors to separate file
<match error.**>
  @type file
  path /var/log/goldshop/errors/goldshop_errors
  append true
  time_slice_format %Y%m%d
  time_slice_wait 10m
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  format json
  include_time_key true
  
  <buffer>
    @type file
    path /var/log/fluentd/buffer/errors
    flush_mode interval
    flush_interval 10s
    chunk_limit_size 5MB
    queue_limit_length 256
  </buffer>
</match>